package controlador.comer;

import java.io.Serializable;
import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashSet;
import java.util.Iterator;
import modelo.*;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.collection.PersistentSet;
import sun.util.calendar.CalendarDate;
import util.HibernateUtil;
import util.NTupla;
import util.Tupla;
import vista.comer.pantallaConsultarObra;

//
//
//  Generated by StarUML(tm) Java Add-In
//
//  @ Project : Proyecto2010_Requerimientos-iuga
//  @ File Name : GestorConsultarObra.java
//  @ Date : 14/06/2010
//  @ Author : 
//
//

public class GestorConsultarObra {
    private PedidoObra pedidoObra;
    private Planta planta;
    private ContactoResponsable contacto;
    private Telefono telefonos;
    private Integer porcentaje;
    private EmpresaCliente empresaCliente;
    private SimpleDateFormat formato;
    private final pantallaConsultarObra pantalla;
    private Localidad localidad;
    private Provincia provincia;
    private Localidad localidadPlanta;
    private Provincia provinciaPlanta;


    public GestorConsultarObra(pantallaConsultarObra aThis) {
        this.pantalla = aThis;
        formato = new SimpleDateFormat("dd/MM/yyyy");
    }


    public void consultarObra() {

    }

    public ArrayList<Tupla> buscarObrasConfirmadas() {
        /**
         *
         * OJO! TODAVIA FALTA SABER COMO VAMOS A VER Q SEAN CONFIRMADAS!!! XD
         * POR AHORA MUESTRO TODAS LAS OBRAS.
         *
        **/
        ArrayList<Tupla> tuplas = new ArrayList<Tupla>();
        SessionFactory sf = HibernateUtil.getSessionFactory();
        Session sesion = sf.openSession();

        sesion.beginTransaction();
        Iterator iter = sesion.createQuery("from PedidoObra p order by p.nombre").iterate();
        while ( iter.hasNext() )
        {
            PedidoObra p = (PedidoObra)iter.next();
            Tupla tupla = new Tupla(p.getId(),p.getNombre());
            tuplas.add(tupla);
        }
        //sesion.flush();
        return tuplas;
    }

    public void seleccionObra(Tupla obra) {
        try{
            SessionFactory sf = HibernateUtil.getSessionFactory();
            Session sesion = sf.openSession();
            sesion.beginTransaction();
            this.pedidoObra = (PedidoObra)sesion.load(PedidoObra.class, obra.getId());
            sesion.getTransaction().commit();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
        }
    }

    public void buscarDatosObra() {

    }

    public void buscarDatosPlanta() {
//        try{
//            SessionFactory sf = HibernateUtil.getSessionFactory();
//            Session sesion = sf.openSession();
//            sesion.beginTransaction();
            this.planta = pedidoObra.getPlanta();
            //this.pedidoObra = (PedidoObra)sesion.load(PedidoObra.class, obra.getId());
 //           sesion.getTransaction().commit();
 //       }
 //       catch(Exception e){
 //           System.out.println("ERROR:"+e.getMessage()+"|");
 //           e.printStackTrace();
  //      }
    }

    public void buscarContactoYTelefono() {

    }

    public void buscarEmpresaCliente() {
        try{
            //SessionFactory sf = HibernateUtil.getSessionFactory();
            //Session sesion = sf.openSession();
            //sesion.beginTransaction();
            //BigDecimal idEC = (BigDecimal)sesion.createSQLQuery("select ID_EMPRESA from PLANTA where ID_PLANTA="+this.planta.getId()).uniqueResult();
            //this.empresaCliente = (EmpresaCliente)sesion.load(EmpresaCliente.class,idEC.intValue());
            //sesion.getTransaction().commit();
            HibernateUtil.beginTransaction();
            BigDecimal idEC = (BigDecimal)HibernateUtil.getSession().createSQLQuery("select ID_EMPRESA from PLANTA where ID_PLANTA="+this.planta.getId()).uniqueResult();
            this.empresaCliente = (EmpresaCliente)HibernateUtil.getSession().load(EmpresaCliente.class,idEC.intValue());
            HibernateUtil.commitTransaction();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
       }
    }

    public void calcularPorcentajeCompletado() {

    }

    public void finCU() {

    }

    public String mostrarNombreObra(){
        return this.pedidoObra.getNombre();
    }

    public String mostrarDescripcionObra(){
        return this.pedidoObra.getDescripcion();
    }

    public String mostrarFechaRegistro(){
        return formato.format(this.pedidoObra.getFechaDeRegistro());
    }

    public String mostrarFechaLVP(){
        return formato.format(this.pedidoObra.getFechaAceptacion());
    }

    public String mostrarFechaAceptacion(){
        return formato.format(this.pedidoObra.getFechaAceptacion());
    }

    public String mostrarFechaLEP(){
        return formato.format(this.pedidoObra.getFechaLimiteEntregaPresupuesto());
    }

    public String mostrarPliego(){
        return this.pedidoObra.getPliego();
    }

    public String mostrarPlanos(){
        return this.pedidoObra.getPlanos();
    }

    public String mostrarMontoObra(){
        return ""+this.pedidoObra.getMonto();
    }

    public String mostrarRazonSocialPlanta(){
        return this.planta.getRazonSocial();
    }

    public String mostrarCallePlanta(){
        return this.planta.getDomicilio().getCalle();
    }

    public String mostrarNumeroPlanta(){
        return ""+this.planta.getDomicilio().getNumero();
    }

    public String mostrarPisoPlanta(){
        return ""+this.planta.getDomicilio().getPiso();
    }

    public String mostrarDptoPlanta(){
        return this.planta.getDomicilio().getDepto();
    }

    public String mostrarCPPlanta(){
        return this.planta.getDomicilio().getCodigoPostal();
    }

    public String mostrarPaisPlanta(){
        Pais p = null;
        try{
            HibernateUtil.beginTransaction();
            BigDecimal idEC = (BigDecimal)HibernateUtil.getSession().createSQLQuery("select PAIS_ID from PROVINCIA where IDPROVINCIA="+this.provinciaPlanta.getId()).uniqueResult();
            p = (Pais)HibernateUtil.getSession().load(Pais.class,idEC.intValue());
            HibernateUtil.commitTransaction();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
       }
       return p.getNombre();
    }

    public String mostrarProvinciaPlanta(){
        Provincia p = null;
        try{
            HibernateUtil.beginTransaction();
            BigDecimal idEC = (BigDecimal)HibernateUtil.getSession().createSQLQuery("select PROVINCIA_ID from LOCALIDAD where IDLOCALIDAD="+this.localidadPlanta.getId()).uniqueResult();
            p = (Provincia)HibernateUtil.getSession().load(Provincia.class,idEC.intValue());
            HibernateUtil.commitTransaction();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
       }
        this.provinciaPlanta = p;
       return p.getNombre();
    }

    public String mostrarLocalidadPlanta(){
        Localidad l = null;
        try{
            HibernateUtil.beginTransaction();
            BigDecimal idEC = (BigDecimal)HibernateUtil.getSession().createSQLQuery("select LOCALIDAD_ID from BARRIO where IDBARRIO="+this.planta.getDomicilio().getBarrio().getId()).uniqueResult();
            l = (Localidad)HibernateUtil.getSession().load(Localidad.class,idEC.intValue());
            HibernateUtil.commitTransaction();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
       }
        this.localidadPlanta = l;
       return l.getNombre();
    }

    public String mostrarBarrioPlanta(){
        return this.planta.getDomicilio().getBarrio().getNombre();
    }

    public String mostrarRazonSocialEC(){
        return this.empresaCliente.getRazonSocial();
    }

    public String mostrarCUITEC(){
        return this.empresaCliente.getCuit();
    }

    public String mostrarDireccionEC(){
        return this.empresaCliente.getDomicilio().toString();
    }

    public String mostrarBarrioEC(){
       return this.empresaCliente.getDomicilio().getBarrio().getNombre();
    }

    public String mostrarLocalidadEC(){
        Localidad l = null;
        try{
            //SessionFactory sf = HibernateUtil.getSessionFactory();
            //Session sesion = sf.openSession();
            //sesion.beginTransaction();
            HibernateUtil.beginTransaction();
            BigDecimal idEC = (BigDecimal)HibernateUtil.getSession().createSQLQuery("select LOCALIDAD_ID from BARRIO where IDBARRIO="+this.empresaCliente.getDomicilio().getBarrio().getId()).uniqueResult();
            l = (Localidad)HibernateUtil.getSession().load(Localidad.class,idEC.intValue());
            //sesion.getTransaction().commit();
            HibernateUtil.commitTransaction();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
       }
        this.localidad = l;
       return l.getNombre();
    }

    public String mostrarProvinciaEC(){
        Provincia p = null;
        try{
            //SessionFactory sf = HibernateUtil.getSessionFactory();
            //Session sesion = sf.openSession();
            //sesion.beginTransaction();
            //BigDecimal idEC = (BigDecimal)sesion.createSQLQuery("select PROVINCIA_ID from LOCALIDAD where IDLOCALIDAD="+this.localidad.getId()).uniqueResult();
            //p = (Provincia)sesion.load(Provincia.class,idEC.intValue());
            //sesion.getTransaction().commit();
            HibernateUtil.beginTransaction();
            BigDecimal idEC = (BigDecimal)HibernateUtil.getSession().createSQLQuery("select PROVINCIA_ID from LOCALIDAD where IDLOCALIDAD="+this.localidad.getId()).uniqueResult();
            p = (Provincia)HibernateUtil.getSession().load(Provincia.class,idEC.intValue());
            HibernateUtil.commitTransaction();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
       }
        this.provincia = p;
       return p.getNombre();
    }

    public String mostrarPaisEC(){
        Pais p = null;
        try{
            //SessionFactory sf = HibernateUtil.getSessionFactory();
            //Session sesion = sf.openSession();
            //sesion.beginTransaction();
            //BigDecimal idEC = (BigDecimal)sesion.createSQLQuery("select PAIS_ID from PROVINCIA where IDPROVINCIA="+this.localidad.getId()).uniqueResult();
            //p = (Pais)sesion.load(Pais.class,idEC.intValue());
            //sesion.getTransaction().commit();
            HibernateUtil.beginTransaction();
            BigDecimal idEC = (BigDecimal)HibernateUtil.getSession().createSQLQuery("select PAIS_ID from PROVINCIA where IDPROVINCIA="+this.provincia.getId()).uniqueResult();
            p = (Pais)HibernateUtil.getSession().load(Pais.class,idEC.intValue());
            HibernateUtil.commitTransaction();
        }
        catch(Exception e){
            System.out.println("ERROR:"+e.getMessage()+"|");
            e.printStackTrace();
       }
       return p.getNombre();
    }

    public HashSet<NTupla> mostrarTelefonosEC() {
        HashSet<NTupla> retorno = new HashSet<NTupla>();
//        SessionFactory sf = HibernateUtil.getSessionFactory();
//        Session sesion = sf.openSession();
//        sesion.beginTransaction();
        PersistentSet tels = (PersistentSet) this.empresaCliente.getTelefonos();
//        sesion.getTransaction().commit();
        for (Object telefono : tels) {
            Telefono t = (Telefono)telefono;
            NTupla nt = new NTupla();
            nt.setId(t.getId());
            nt.setNombre(t.getTipo().getNombre());
            nt.setData(t.getNumero());
            retorno.add(nt);
        }
        return retorno;
    }
}
